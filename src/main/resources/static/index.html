<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhantomQuery</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .control-panel {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result-panel {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        .button.stop {
            background-color: #f44336;
        }
        .button.get-answers {
            background-color: #2196F3;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .status.active {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .status.inactive {
            background-color: #ffebee;
            color: #c62828;
        }
        .transcription-container {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            background-color: #f9f9f9;
            border-left: 4px solid #2196F3;
        }
        .transcription-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .transcription-text {
            width: 100%;
            min-height: 60px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: white;
            resize: vertical;
        }
        .ai-response {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background-color: #e3f2fd;
            border-left: 4px solid #4CAF50;
        }
        .refresh-button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        .timestamp {
            color: #666;
            font-size: 12px;
        }
        .transcription-list {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PhantomQuery</h1>
        
        <div class="control-panel">
            <button id="startButton" class="button">Start Audio Capture</button>
            <button id="stopButton" class="button stop">Stop Audio Capture</button>
            <button id="refreshButton" class="refresh-button">Refresh Status</button>
            <button id="googleCloudStatusButton" class="refresh-button">Check Google Cloud Status</button>
        </div>

        <div class="status-panel">
            <div id="statusIndicator" class="status inactive">Status: Inactive</div>
            <div id="googleCloudStatus" class="status inactive">Google Cloud: Not checked</div>
            <div class="result-panel">
                <h3>Transcriptions</h3>
                <div id="transcriptionList" class="transcription-list">
                    <!-- Transcriptions will be added here dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const refreshButton = document.getElementById('refreshButton');
            const googleCloudStatusButton = document.getElementById('googleCloudStatusButton');
            const statusIndicator = document.getElementById('statusIndicator');
            const googleCloudStatus = document.getElementById('googleCloudStatus');
            const transcriptionList = document.getElementById('transcriptionList');
            
            // Initial status update
            updateStatus();
            
            // Update status function
            function updateStatus() {
                fetch('/api/capture/status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.isCapturing) {
                            statusIndicator.textContent = 'Status: Active';
                            statusIndicator.className = 'status active';
                        } else {
                            statusIndicator.textContent = 'Status: Inactive';
                            statusIndicator.className = 'status inactive';
                        }
                        
                        // Check if we have a new transcription
                        if (data.lastTranscription && 
                            !data.lastTranscription.includes("No transcription yet") &&
                            !data.lastTranscription.includes("No speech detected")) {
                            
                            // Check if this transcription is already displayed
                            const existingTranscriptions = document.querySelectorAll('.transcription-container');
                            let isNewTranscription = true;
                            
                            existingTranscriptions.forEach(container => {
                                const textArea = container.querySelector('.transcription-text');
                                if (textArea && textArea.value === data.lastTranscription) {
                                    isNewTranscription = false;
                                }
                            });
                            
                            // If it's a new transcription, add it to the list
                            if (isNewTranscription) {
                                addTranscription(data.lastTranscription);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching status:', error);
                        statusIndicator.textContent = 'Status: Error fetching status';
                        statusIndicator.className = 'status inactive';
                    });
            }
            
            // Function to add a new transcription
            function addTranscription(text) {
                const container = document.createElement('div');
                container.className = 'transcription-container';
                
                const header = document.createElement('div');
                header.className = 'transcription-header';
                
                const timestamp = document.createElement('div');
                timestamp.className = 'timestamp';
                timestamp.textContent = new Date().toLocaleTimeString();
                
                const getAnswersButton = document.createElement('button');
                getAnswersButton.className = 'button get-answers';
                getAnswersButton.textContent = 'Get Answers';
                
                header.appendChild(timestamp);
                header.appendChild(getAnswersButton);
                
                const textArea = document.createElement('textarea');
                textArea.className = 'transcription-text';
                textArea.value = text;
                textArea.readOnly = true;
                
                const aiResponse = document.createElement('div');
                aiResponse.className = 'ai-response';
                aiResponse.textContent = 'Click "Get Answers" to get AI response';
                
                container.appendChild(header);
                container.appendChild(textArea);
                container.appendChild(aiResponse);
                
                // Add event listener to the Get Answers button
                getAnswersButton.addEventListener('click', function() {
                    const transcriptionText = textArea.value;
                    
                    // Send to OpenAI for processing
                    fetch('/api/capture/process-transcription', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ transcription: transcriptionText })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            aiResponse.textContent = data.aiResponse;
                            getAnswersButton.disabled = true;
                            getAnswersButton.textContent = 'Answers Received';
                    } else {
                            aiResponse.textContent = 'Error: ' + data.error;
                        }
                    })
                    .catch(error => {
                        console.error('Error getting AI response:', error);
                        aiResponse.textContent = 'Error getting AI response. See console for details.';
                    });
                });
                
                // Add the new transcription to the top of the list
                transcriptionList.insertBefore(container, transcriptionList.firstChild);
            }
            
            // Start audio capture
            startButton.addEventListener('click', function() {
                fetch('/api/capture/start', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateStatus();
                        } else {
                            alert('Failed to start audio capture: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error starting audio capture:', error);
                        alert('Error starting audio capture. See console for details.');
                    });
            });
            
            // Stop audio capture
            stopButton.addEventListener('click', function() {
                fetch('/api/capture/stop', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateStatus();
                        } else {
                            alert('Failed to stop audio capture: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error stopping audio capture:', error);
                        alert('Error stopping audio capture. See console for details.');
                    });
            });
            
            // Refresh status
            refreshButton.addEventListener('click', function() {
                updateStatus();
            });
            
            // Check Google Cloud status
            googleCloudStatusButton.addEventListener('click', function() {
                fetch('/api/capture/google-cloud-status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (data.googleCloudAvailable) {
                                googleCloudStatus.textContent = 'Google Cloud: Available';
                                googleCloudStatus.className = 'status active';
                            } else {
                                googleCloudStatus.textContent = 'Google Cloud: Not available - Check logs for details';
                                googleCloudStatus.className = 'status inactive';
                            }
                            
                            if (data.credentialsPath) {
                                console.log('Google Cloud credentials path: ' + data.credentialsPath);
                            }
                        } else {
                            googleCloudStatus.textContent = 'Google Cloud: Error checking status';
                            googleCloudStatus.className = 'status inactive';
                            console.error('Error checking Google Cloud status:', data.error);
                        }
            })
            .catch(error => {
                        console.error('Error checking Google Cloud status:', error);
                        googleCloudStatus.textContent = 'Google Cloud: Error checking status';
                        googleCloudStatus.className = 'status inactive';
                    });
            });
            
            // Set up periodic status updates
            setInterval(updateStatus, 5000);
        });
    </script>
</body>
</html> 